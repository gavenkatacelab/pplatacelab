name: Query Dataverse API

on:
  workflow_dispatch: # Manual trigger

jobs:
  query-dataverse:
    runs-on: ubuntu-latest
    steps:
      - name: Get Azure AD Token
        id: get_token
        run: |
          sudo apt-get update && sudo apt-get install -y jq curl
          
          TOKEN=$(curl -s -X POST \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=${{ vars.PPLAT_APP_ID }}" \
            -d "scope=${{ vars.PROD_URL }}/.default" \
            -d "client_secret=${{ secrets.envSecret }}" \ 
            -d "grant_type=client_credentials" \
            "https://login.microsoftonline.com/${{ vars.TENANT_ID }}/oauth2/v2.0/token" \
            | jq -r '.access_token')

          echo " The token is $TOKEN" >> $GITHUB_OUTPUT
          
          if [ -z "$TOKEN" ] || [ "$TOKEN" == "null" ]; then
            echo "Failed to get token"
            exit 1
          fi
          
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Query Dataverse
        run: |
          RESPONSE=$(curl -s -X GET \
            "${{ vars.PROD_URL }}/api/data/v9.2/asyncoperations(5232285b-60bf-f011-bbd2-002248081a04)" \
            -H "Authorization: Bearer ${{ steps.get_token.outputs.token }}" \
            -H "Accept: application/json")
          
          echo "Dataverse Response:"
          echo "$RESPONSE" | jq .
